<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Tracker Dashboard</title>

    <!-- Chart.js for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Paho MQTT Client for WebSockets -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: #ecf0f1; text-align: center; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }

        .cards { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
        .card { background: #2c3e50; padding: 20px; border-radius: 10px; width: 200px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .card h2 { margin: 0; font-size: 1.2em; color: #bdc3c7; }
        .card .value { font-size: 2.5em; font-weight: bold; margin: 10px 0; }
        .card .unit { font-size: 0.5em; color: #95a5a6; }

        .status-clean { color: #2ecc71; }
        .status-detect { color: #f1c40f; }
        .status-high { color: #e74c3c; }

        .bpm-anim { animation: pulse 1s infinite; display: inline-block; }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); color: #e74c3c; }
            100% { transform: scale(1); }
        }

        .chart-container { background: #2c3e50; padding: 20px; border-radius: 10px; height: 400px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Vital Signs Monitor</h1>
        <p>Status: <span id="connection-status" style="color: red;">Disconnected</span></p>

        <div class="cards">
            <!-- Temp Card -->
            <div class="card">
                <h2>Body Temp</h2>
                <div class="value" id="temp-val">--</div>
                <span class="unit">°C</span>
            </div>

            <!-- Heart Rate Card -->
            <div class="card">
                <h2>Heart Rate</h2>
                <div class="value">
                    <span id="bpm-val">--</span>
                    <span id="heart-icon" style="font-size: 0.6em;">❤️</span>
                </div>
                <span class="unit">BPM</span>
            </div>

            <!-- SpO2 Card -->
            <div class="card">
                <h2>Oxygen (SpO2)</h2>
                <div class="value" id="spo2-val">--</div>
                <span class="unit">%</span>
            </div>

            <!-- Alcohol Card -->
            <div class="card">
                <h2>Alcohol Level</h2>
                <div class="value" id="alc-val">--</div>
                <span class="unit">Raw Value</span>
            </div>

            <!-- Status Card -->
            <div class="card">
                <h2>Breath Status</h2>
                <div class="value" id="status-val">--</div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="healthChart"></canvas>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const MQTT_BROKER = "localhost"; // Use "localhost" if on same PC
        const MQTT_PORT = 9001;          // WebSocket Port
        const MQTT_TOPIC = "health/stats";

        // --- CHART SETUP ---
        const ctx = document.getElementById('healthChart').getContext('2d');
        const healthChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Temp (°C)',
                    borderColor: '#e74c3c', // Red
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    data: [],
                    yAxisID: 'y',
                    tension: 0.4
                }, {
                    label: 'Heart Rate',
                    borderColor: '#9b59b6', // Purple
                    backgroundColor: 'rgba(155, 89, 182, 0.1)',
                    data: [],
                    yAxisID: 'y_bpm',
                    tension: 0.4
                }, {
                    label: 'SpO2 (%)',
                    borderColor: '#2ecc71', // Green
                    backgroundColor: 'rgba(46, 204, 113, 0.1)',
                    data: [],
                    yAxisID: 'y_bpm', // Share axis with BPM
                    tension: 0.4
                }, {
                    label: 'Alcohol',
                    borderColor: '#3498db', // Blue
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    data: [],
                    yAxisID: 'y1',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    y: {
                        type: 'linear', display: true, position: 'left',
                        title: { display: true, text: 'Temp (°C)' },
                        suggestedMin: 20, suggestedMax: 45
                    },
                    y_bpm: {
                        type: 'linear', display: true, position: 'right',
                        title: { display: true, text: 'BPM / SpO2' },
                        grid: { drawOnChartArea: false },
                        suggestedMin: 40, suggestedMax: 110
                    },
                    y1: {
                        type: 'linear', display: true, position: 'right',
                        title: { display: true, text: 'Alcohol' },
                        min: 0, max: 4095, grid: { drawOnChartArea: false }
                    }
                }
            }
        });

        // --- MQTT CONNECTION ---
        const clientID = "web_client_" + new Date().getTime();
        const client = new Paho.MQTT.Client(MQTT_BROKER, MQTT_PORT, clientID);

        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;
        client.connect({ onSuccess: onConnect, onFailure: onFail });

        function onConnect() {
            document.getElementById("connection-status").innerText = "Connected via WebSockets";
            document.getElementById("connection-status").style.color = "#2ecc71";
            client.subscribe(MQTT_TOPIC);
        }

        function onFail(responseObject) {
            document.getElementById("connection-status").innerText = "Connection Failed";
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                document.getElementById("connection-status").innerText = "Connection Lost";
                document.getElementById("connection-status").style.color = "red";
            }
        }

        function onMessageArrived(message) {
            try {
                const data = JSON.parse(message.payloadString);
                updateDashboard(data);
            } catch (e) {
                console.error("JSON Parse Error", e);
            }
        }

        function updateDashboard(data) {
            // Update Text Cards
            document.getElementById("temp-val").innerText = data.temp !== null ? parseFloat(data.temp).toFixed(1) : "Err";
            document.getElementById("alc-val").innerText = data.alcohol;

            const statusEl = document.getElementById("status-val");
            statusEl.innerText = data.status;
            statusEl.className = "value";
            if (data.status === "Clean") statusEl.classList.add("status-clean");
            else if (data.status === "Detected") statusEl.classList.add("status-detect");
            else statusEl.classList.add("status-high");

            // Handle BPM & SpO2 display
            let bpmDisplay = "--";
            let spo2Display = "--";

            // Logic: Only show data if finger is detected (boolean check)
            if (data.finger === true) {
                if (data.bpm > 0) bpmDisplay = data.bpm;
                if (data.spo2 > 0) spo2Display = parseFloat(data.spo2).toFixed(1);
            }

            document.getElementById("bpm-val").innerText = bpmDisplay;
            document.getElementById("spo2-val").innerText = spo2Display;

            // Heart Icon Animation
            const heartIcon = document.getElementById("heart-icon");
            if (data.finger === true) {
                heartIcon.classList.add("bpm-anim");
                if(data.bpm > 0) heartIcon.style.animationDuration = (60 / data.bpm) + "s";
            } else {
                heartIcon.classList.remove("bpm-anim");
            }

            // Update Chart
            const timeLabel = new Date().toLocaleTimeString();

            if (healthChart.data.labels.length > 30) {
                healthChart.data.labels.shift();
                healthChart.data.datasets.forEach(ds => ds.data.shift());
            }

            healthChart.data.labels.push(timeLabel);
            healthChart.data.datasets[0].data.push(data.temp);    // Temp
            healthChart.data.datasets[1].data.push(data.bpm);     // BPM
            healthChart.data.datasets[2].data.push(data.spo2);    // SpO2
            healthChart.data.datasets[3].data.push(data.alcohol); // Alcohol

            healthChart.update();
        }
    </script>
</body>
</html>
