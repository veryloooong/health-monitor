<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Tracker Dashboard</title>
    
    <!-- Chart.js for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Paho MQTT Client for WebSockets -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: #ecf0f1; text-align: center; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        .cards { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; }
        .card { background: #2c3e50; padding: 20px; border-radius: 10px; width: 200px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .card h2 { margin: 0; font-size: 1.2em; color: #bdc3c7; }
        .card .value { font-size: 2.5em; font-weight: bold; margin: 10px 0; }
        .card .unit { font-size: 0.5em; color: #95a5a6; }

        .status-clean { color: #2ecc71; }
        .status-detect { color: #f1c40f; }
        .status-high { color: #e74c3c; }

        .chart-container { background: #2c3e50; padding: 20px; border-radius: 10px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Vital Signs Monitor</h1>
        <p>Status: <span id="connection-status" style="color: red;">Disconnected</span></p>

        <div class="cards">
            <!-- Temp Card -->
            <div class="card">
                <h2>Body Temp</h2>
                <div class="value" id="temp-val">--</div>
                <span class="unit">°C</span>
            </div>

            <!-- Alcohol Card -->
            <div class="card">
                <h2>Alcohol Level</h2>
                <div class="value" id="alc-val">--</div>
                <span class="unit">Raw Value</span>
            </div>

            <!-- Status Card -->
            <div class="card">
                <h2>Air Status</h2>
                <div class="value" id="status-val">--</div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="healthChart"></canvas>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const MQTT_BROKER = "localhost"; // Use "localhost" if opening on the same PC
        const MQTT_PORT = 9001;          // WebSocket Port (Not 1883!)
        const MQTT_TOPIC = "health/stats";

        // --- CHART SETUP ---
        const ctx = document.getElementById('healthChart').getContext('2d');
        const healthChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Temperature (°C)',
                    borderColor: '#e74c3c',
                    data: [],
                    yAxisID: 'y',
                }, {
                    label: 'Alcohol Level',
                    borderColor: '#3498db',
                    data: [],
                    yAxisID: 'y1',
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { type: 'linear', display: true, position: 'left', min: 20, max: 45 },
                    y1: { type: 'linear', display: true, position: 'right', min: 0, max: 4095, grid: { drawOnChartArea: false } }
                }
            }
        });

        // --- MQTT CONNECTION ---
        const clientID = "web_client_" + new Date().getTime();
        const client = new Paho.MQTT.Client(MQTT_BROKER, MQTT_PORT, clientID);

        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;

        // Connect
        client.connect({ onSuccess: onConnect, onFailure: onFail });

        function onConnect() {
            document.getElementById("connection-status").innerText = "Connected via WebSockets";
            document.getElementById("connection-status").style.color = "#2ecc71";
            console.log("Connected to MQTT Broker");
            client.subscribe(MQTT_TOPIC);
        }

        function onFail(responseObject) {
            console.log("Connection failed: " + responseObject.errorMessage);
            document.getElementById("connection-status").innerText = "Connection Failed (Check Console)";
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("Connection lost: " + responseObject.errorMessage);
                document.getElementById("connection-status").innerText = "Connection Lost";
                document.getElementById("connection-status").style.color = "red";
            }
        }

        function onMessageArrived(message) {
            console.log("Data Received: " + message.payloadString);
            
            try {
                const data = JSON.parse(message.payloadString);
                updateDashboard(data);
            } catch (e) {
                console.error("JSON Parse Error", e);
            }
        }

        function updateDashboard(data) {
            // Update Text Cards
            document.getElementById("temp-val").innerText = data.temp !== null ? data.temp.toFixed(1) : "Err";
            document.getElementById("alc-val").innerText = data.alcohol;
            
            const statusEl = document.getElementById("status-val");
            statusEl.innerText = data.status;

            // Color Coding
            statusEl.className = "value"; // reset
            if (data.status === "Clean") statusEl.classList.add("status-clean");
            else if (data.status === "Detected") statusEl.classList.add("status-detect");
            else statusEl.classList.add("status-high");

            // Update Chart
            const timeLabel = new Date().toLocaleTimeString();
            
            // Add new data
            if (healthChart.data.labels.length > 20) {
                healthChart.data.labels.shift(); // Remove oldest
                healthChart.data.datasets[0].data.shift();
                healthChart.data.datasets[1].data.shift();
            }

            healthChart.data.labels.push(timeLabel);
            healthChart.data.datasets[0].data.push(data.temp);
            healthChart.data.datasets[1].data.push(data.alcohol);
            healthChart.update();
        }
    </script>
</body>
</html>